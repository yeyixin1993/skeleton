<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script>
        const api = "http://localhost:8080";
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        $(function(){
            const api = "http://localhost:8080"; // <- do not need a root api URL if this page is served directly by the API
            const x = " X";

            $(document).on('click','.tagValue',function(){
                $.ajax({
                    type: 'PUT',
                    url: '/tags/'+$(this).text(),
                    data: $(this).parent().parent().attr('id'),

                    success: function(data) {

                    },
                    contentType: "application/json",
                    dataType: 'json',
                });
                $(this).remove();
            });

            $(document).on('click','.add-tag',function(){
                $(this).after("<input class='tag_input' style='height:20px;' type='text'></input>");

            });

            $(document).on('keypress','.tag_input',function(f){
                var tag = $(this).val();
                if(f.keyCode == 13)
                {
                    $.ajax({
                        type: 'PUT',
                        url: '/tags/'+$(this).val(),
                        data: $(this).parent().parent().attr('id'),

                        success: function(data) {

                        },
                        contentType: "application/json",
                        dataType: 'json',
                    });

                    $(`<button class="tagValue">${tag}</button>`)
                        .appendTo($('.tags', $("#"+$(this).parent().parent().attr('id'))));
                    $(this).remove();

                }

            });



            function tagRemoval(receiptId, tag) {
                $.put(api+"/tags" + "/" + tag.innerText.slice(0, -x.length), receiptId, function() {
                    tag.remove();
                }, 'application/json');
            }

            $.getJSON(api+"/receipts", function(receipts){
                var idset = [];
                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    console.log(receipt);
                    if($.inArray(receipt.id, idset)==-1){
                        //none
                        $(`<div class="receipt" id="${receipt.id}"><span class="time">${receipt.created}</span>
                        <span class="merchant">${receipt.merchantName}</span>
                        <span class="amount">${receipt.value}</span>
                        <span class="tags">

                        <button class="add-tag">Add +</button></span>`)
                            .appendTo($("#receiptList"));
                        idset.push(receipt.id);
                    }else{
                        $(`<button class="tagValue">${receipt.tag}</button>`)
                            .appendTo($('.tags', $("#"+receipt.id)));
                    }
                    // $(`<div class="receipt">${receipt.merchantName}<div><span class="receiptTag">t1</span></div></div>`)
                     //   .appendTo($("#receiptList"));
                }

            });

            $('#save-receipt').on('click', function () {
                var data = {
                    merchant: $('#merchant').val(),
                    amount: $('#amount').val()
                };

                if (data.merchant == "") {
                    alert("Merchant information cannot be empty.");
                    return;
                }

                if (data.amount == "") {
                    alert("Amount cannot be empty.");
                    return;
                }

                $.ajax({
                    url: api + "/receipts",
                    dataType: 'json',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (receipt) {
                        var d = new Date();
                        var time = d.getHours() + ":" + d.getMinutes();

                        $(`<div class="receipt">
                        <span class="time">${time}</span>
                        <span class="merchant">${$("#merchant").val()}</span>
                        <span class="amount">${$("#amount").val()}</span>
                        <span class="tags">

                        <button class="add-tag">Add +</button></span>`)
                            .appendTo($("#receiptList"));

                        $('#merchant').val('');
                        $('#amount').val('');
                        $('#add-receipt').hide();
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
            });

            $(`<div class="receiptHeader">
                <span>Time</span>
                <span>Merchant</span>
                <span>$</span>
                <span>Tags</span>
            </div>`)
                .appendTo($("#receiptList"));

        });

        function addReceiptForm() {
            console.log("+ button was clicked");
            $('#add-receipt').show();
        }

        function cancelReceipt(){
            $('#merchant').val('');
            $('#amount').val('');
            $('#add-receipt').hide();
        }


        function getTime(timestamp) {
            var currentTimestamp = new Date().getTime();
            var elapsed = currentTimestamp - timestamp;
            return elapsed+" ago";
        }

    </script>
</head>

<body>
    <DIV id="container">
        <h1>My receipts</h1>
        <div class="button" onclick="addReceiptForm()">+</div>
        <div id="add-receipt">
            <input id="merchant" type="text" placeholder="Please type merchant">
            <input id="amount" type="number" placeholder="Please type amount">
            <div class="">
                <button class="cancel-receipt" style="margin-left:46%;" onclick="cancelReceipt()">Cancel</button>
                <button id="save-receipt">Save</button>
            </div>
        </div>
        <div id="receiptList">
        </div>
    </DIV>
</body>


</html>
